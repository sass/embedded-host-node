name: CI

defaults:
  run: {shell: bash}

env:
  PROTOC_VERSION: 3.x
  DEFAULT_NODE_VERSION: 18.x # If changing this, also change jobs.tests.strategy.matrix.node_version

on:
  push:
    branches: [main, feature.*]
    tags: ['**']
  pull_request:

jobs:
  tests:
    name: 'Tests | Node ${{ matrix.node-version }} | ${{ matrix.os }}'
    runs-on: ${{ matrix.os }}-latest

    strategy:
      matrix:
        os: [windows]
        node-version: [18.x] # If changing this, also change env.DEFAULT_NODE_VERSION
      fail-fast: false

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          check-latest: true
      - uses: dart-lang/setup-dart@v1
        with: {sdk: stable}
      - run: dart --version

      - name: Check out Dart Sass
        uses: sass/clone-linked-repo@v1
        with: {repo: sass/dart-sass}

      - name: Check out the language repo
        uses: sass/clone-linked-repo@v1
        with: {repo: sass/sass, path: language}

      - name: Check language/spec
        run: |
          ls -l language/spec;
          cat language/spec/README.md;

      - run: npm install
      - name: npm run init
        run: |
          npm run init -- --compiler-path=dart-sass --language-path=language $args

      - run: npm run test
      - run: npm run compile
      - run: node test/after-compile-test.mjs
